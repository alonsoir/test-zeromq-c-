.PHONY: help status
.PHONY: up halt destroy ssh
.PHONY: lab-start lab-stop lab-restart lab-ps lab-logs lab-clean
.PHONY: proto proto-unified proto-verify sniffer detector firewall all rebuild
.PHONY: sniffer-build sniffer-clean sniffer-package sniffer-install
.PHONY: detector-build detector-clean
.PHONY: firewall-build firewall-clean
.PHONY: run-sniffer run-detector run-firewall
.PHONY: logs-sniffer logs-detector logs-firewall logs-lab
.PHONY: run-lab-dev kill-lab status-lab
.PHONY: kill-all check-ports restart
.PHONY: clean distclean test dev-setup schema-update
.PHONY: build-unified rebuild-unified create-verify-script quick-fix dev-setup-unified

# ============================================================================
# ML Defender Pipeline - Host Makefile
# Run from macOS - Commands execute in VM via vagrant ssh -c
# ============================================================================

help:
	@echo ""
	@echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
	@echo "â•‘  ML Defender Pipeline - Development Makefile               â•‘"
	@echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
	@echo ""
	@echo "VM Management:"
	@echo "  make up              - Start VM"
	@echo "  make halt            - Stop VM"
	@echo "  make destroy         - Destroy VM"
	@echo "  make ssh             - SSH into VM"
	@echo "  make status          - Show VM status"
	@echo ""
	@echo "Docker Lab:"
	@echo "  make lab-start       - Start docker-compose lab"
	@echo "  make lab-stop        - Stop docker-compose lab"
	@echo "  make lab-ps          - Show lab containers"
	@echo "  make lab-logs        - Show lab logs"
	@echo "  make lab-clean       - Stop and remove lab"
	@echo ""
	@echo "Build:"
	@echo "  make all             - Build sniffer + detector + firewall"
	@echo "  make proto           - Regenerate protobuf schema (unified)"
	@echo "  make proto-unified   - Protobuf unified system"
	@echo "  make proto-verify    - Verify protobuf consistency"
	@echo "  make sniffer         - Build sniffer"
	@echo "  make detector        - Build ml-detector"
	@echo "  make firewall        - Build firewall-acl-agent"
	@echo "  make rebuild         - Clean + build all (unified)"
	@echo "  make build-unified   - Build with unified protobuf"
	@echo "  make rebuild-unified - Clean + unified build"
	@echo ""
	@echo "Sniffer Packaging:"
	@echo "  make sniffer-package - Create .deb package"
	@echo "  make sniffer-install - Install .deb in VM"
	@echo ""
	@echo "Run Components (individual):"
	@echo "  make run-firewall    - Run firewall (Terminal 1)"
	@echo "  make run-detector    - Run detector (Terminal 2)"
	@echo "  make run-sniffer     - Run sniffer (Terminal 3)"
	@echo ""
	@echo "Run Lab (integrated):"
	@echo "  make run-lab-dev     - ðŸš€ START FULL LAB (background + monitor)"
	@echo "  make kill-lab        - Stop full lab"
	@echo "  make status-lab      - Show lab status"
	@echo "  make logs-lab        - Combined logs (all 3 components)"
	@echo ""
	@echo "Logs (individual):"
	@echo "  make logs-firewall   - Show firewall logs"
	@echo "  make logs-detector   - Show detector logs"
	@echo "  make logs-sniffer    - Show sniffer logs"
	@echo ""
	@echo "Development:"
	@echo "  make dev-setup       - Full setup (up + lab + build)"
	@echo "  make dev-setup-unified - Setup with unified protobuf"
	@echo "  make test            - Check what's built"
	@echo "  make schema-update   - Update schema + rebuild"
	@echo "  make quick-fix       - Quick bug fix procedure"
	@echo ""
	@echo "Troubleshooting:"
	@echo "  make kill-all        - Kill all processes"
	@echo "  make check-ports     - Check if ports are in use"
	@echo "  make clean           - Clean build artifacts"
	@echo ""

# ============================================================================
# VM Management
# ============================================================================

up:
	@vagrant up

halt:
	@vagrant halt

destroy:
	@vagrant destroy -f

ssh:
	@vagrant ssh

status:
	@vagrant status

# ============================================================================
# Docker Lab
# ============================================================================

lab-start:
	@echo "ðŸš€ Starting Docker Lab..."
	@vagrant ssh -c "cd /vagrant && docker-compose up -d"
	@make lab-ps

lab-stop:
	@echo "â¸ï¸  Stopping Docker Lab..."
	@vagrant ssh -c "cd /vagrant && docker-compose stop"

lab-restart:
	@vagrant ssh -c "cd /vagrant && docker-compose restart"

lab-ps:
	@echo "ðŸ“¦ Lab Containers:"
	@vagrant ssh -c "cd /vagrant && docker-compose ps"

lab-logs:
	@echo "ðŸ“‹ Lab Logs:"
	@vagrant ssh -c "cd /vagrant && docker-compose logs --tail=50 -f"

lab-clean:
	@echo "ðŸ§¹ Cleaning Docker Lab..."
	@vagrant ssh -c "cd /vagrant && docker-compose down -v"

# ============================================================================
# Protobuf Schema - UNIFIED SYSTEM
# ============================================================================

PROTOBUF_VERIFY_SCRIPT := /vagrant/scripts/verify_protobuf.sh

proto-unified:
	@echo "ðŸ”¨ Protobuf Unified System..."
	@vagrant ssh -c "cd /vagrant/protobuf && chmod +x generate.sh && ./generate.sh"

proto-verify:
	@echo "ðŸ” Verificando consistencia protobuf..."
	@vagrant ssh -c "cd /vagrant && bash scripts/verify_protobuf.sh"

proto: proto-unified
	@echo "âœ… Protobuf unificado generado y distribuido"

# ============================================================================
# Build Targets - UPDATED FOR UNIFIED PROTOBUF
# ============================================================================

sniffer: proto
	@echo "ðŸ”¨ Building Sniffer..."
	@vagrant ssh -c "cd /vagrant/sniffer && make"

sniffer-build: sniffer

sniffer-clean:
	@echo "ðŸ§¹ Cleaning Sniffer..."
	@vagrant ssh -c "cd /vagrant/sniffer && make clean"

sniffer-package:
	@echo "ðŸ“¦ Creating Sniffer .deb package..."
	@vagrant ssh -c "cd /vagrant/sniffer && make && ./scripts/create_deb.sh"
	@vagrant ssh -c "ls -lh /vagrant/sniffer/*.deb"

sniffer-install: sniffer-package
	@echo "ðŸ“¥ Installing Sniffer .deb..."
	@vagrant ssh -c "cd /vagrant/sniffer && sudo dpkg -i *.deb || sudo apt-get install -f -y"

detector: proto
	@echo "ðŸ”¨ Building ML Detector..."
	@vagrant ssh -c "mkdir -p /vagrant/ml-detector/build && cd /vagrant/ml-detector/build && cmake .. && make -j4"

detector-build: detector

detector-clean:
	@echo "ðŸ§¹ Cleaning ML Detector..."
	@vagrant ssh -c "rm -rf /vagrant/ml-detector/build/*"

firewall: proto
	@echo "ðŸ”¨ Building Firewall ACL Agent..."
	@vagrant ssh -c "mkdir -p /vagrant/firewall-acl-agent/build && cd /vagrant/firewall-acl-agent/build && cmake .. && make -j4"

firewall-build: firewall

firewall-clean:
	@echo "ðŸ§¹ Cleaning Firewall ACL Agent..."
	@vagrant ssh -c "rm -rf /vagrant/firewall-acl-agent/build/*"

# Build con protobuf unificado
build-unified: proto-unified sniffer detector firewall
	@echo "ðŸš€ Build completo con protobuf unificado"
	@$(MAKE) proto-verify

all: build-unified
	@echo "âœ… All components built con protobuf unificado"

rebuild-unified: clean build-unified
	@echo "âœ… Rebuild completo con protobuf unificado"

rebuild: rebuild-unified
	@echo "âœ… Full rebuild complete con protobuf unificado"

clean: sniffer-clean detector-clean firewall-clean
	@echo "âœ… Clean complete"

distclean: clean
	@vagrant ssh -c "rm -f /vagrant/protobuf/network_security.pb.* /vagrant/protobuf/network_security_pb2.py"

# ============================================================================
# Run Individual Components
# ============================================================================

run-firewall:
	@echo "ðŸ”¥ Running Firewall ACL Agent..."
	@echo "âš ï¸  Requires: Detector running on tcp://localhost:5572"
	@vagrant ssh -c "cd /vagrant/firewall-acl-agent/build && sudo ./firewall-acl-agent -c ../config/firewall.json"

run-detector:
	@echo "ðŸ¤– Running ML Detector..."
	@echo "âš ï¸  Requires: Sniffer running on tcp://127.0.0.1:5571"
	@vagrant ssh -c "cd /vagrant/ml-detector/build && ./ml-detector -c config/ml_detector_config.json"

run-sniffer:
	@echo "ðŸ“¡ Running Sniffer..."
	@vagrant ssh -c "cd /vagrant/sniffer/build && sudo ./sniffer -c config/sniffer.json"

# ============================================================================
# Run Full Lab (Development Mode)
# ============================================================================

run-lab-dev:
	@echo ""
	@echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
	@echo "â•‘  ðŸš€ Starting ML Defender Lab (Development Mode)            â•‘"
	@echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
	@echo ""
	@echo "ðŸ“‹ Execution Order:"
	@echo "   1ï¸âƒ£  Firewall ACL Agent  (SUB tcp://localhost:5572)"
	@echo "   2ï¸âƒ£  ML Detector         (PUB tcp://0.0.0.0:5572)"
	@echo "   3ï¸âƒ£  Sniffer             (PUSH tcp://127.0.0.1:5571)"
	@echo ""
	@vagrant ssh -c "cd /vagrant && bash scripts/run_lab_dev.sh"

kill-lab:
	@echo "ðŸ’€ Stopping ML Defender Lab..."
	@vagrant ssh -c "sudo pkill -f -9 firewall-acl-agent || true"
	@vagrant ssh -c "pkill -f -9 ml-detector || true"
	@vagrant ssh -c "sudo pkill -f -9 sniffer || true"
	@sleep 2
	@echo "âœ… Lab stopped"

status-lab:
	@echo "ðŸ“Š ML Defender Lab Status:"
	@echo ""
	@vagrant ssh -c "pgrep -a firewall-acl-agent | head -1 | awk '{print \"Firewall: âœ… PID\", \$$1}' || echo 'Firewall: âŒ Not running'"
	@vagrant ssh -c "pgrep -a ml-detector | head -1 | awk '{print \"Detector: âœ… PID\", \$$1}' || echo 'Detector: âŒ Not running'"
	@vagrant ssh -c "pgrep -a sniffer | head -1 | awk '{print \"Sniffer:  âœ… PID\", \$$1}' || echo 'Sniffer:  âŒ Not running'"
	@echo ""
	@vagrant ssh -c "sudo ss -tlnp | grep -E '5571|5572' || echo 'Ports: âš ï¸  Not listening'"

logs-lab:
	@echo "ðŸ“‹ Combined Logs (all components):"
	@vagrant ssh -c "cd /vagrant && bash scripts/monitor_lab.sh"

# ============================================================================
# Individual Logs
# ============================================================================

logs-firewall:
	@vagrant ssh -c "tail -50 /vagrant/firewall-acl-agent/build/logs/*.log 2>/dev/null || tail -50 /var/log/ml-defender/firewall-acl-agent.log 2>/dev/null || echo 'No logs yet'"

logs-detector:
	@vagrant ssh -c "tail -50 /vagrant/ml-detector/build/logs/*.log 2>/dev/null || echo 'No logs yet'"

logs-sniffer:
	@vagrant ssh -c "tail -50 /vagrant/sniffer/build/logs/*.log 2>/dev/null || echo 'No logs yet'"

# ============================================================================
# Development Helpers
# ============================================================================

dev-setup: up lab-start all
	@echo ""
	@echo "âœ… Development environment ready"
	@echo ""
	@echo "Next steps:"
	@echo "  make run-lab-dev     - Start full integrated lab"
	@echo "  make ssh             - SSH into VM for debugging"
	@echo ""

test:
	@echo "ðŸ§ª Testing build artifacts..."
	@vagrant ssh -c "echo 'Sniffer:  \$$([ -f /vagrant/sniffer/build/sniffer ] && echo âœ… || echo âŒ)' && echo 'Detector: \$$([ -f /vagrant/ml-detector/build/ml-detector ] && echo âœ… || echo âŒ)' && echo 'Firewall: \$$([ -f /vagrant/firewall-acl-agent/build/firewall-acl-agent ] && echo âœ… || echo âŒ)' && echo 'Protobuf: \$$([ -f /vagrant/protobuf/network_security.pb.cc ] && echo âœ… || echo âŒ)'"

schema-update: proto rebuild

check-ports:
	@vagrant ssh -c "sudo ss -tlnp | grep -E '5571|5572' && echo 'âš ï¸  Ports in use' || echo 'âœ… Ports free'"

kill-all: kill-lab

restart: kill-lab
	@echo "â™»ï¸  Restart with: make run-lab-dev"

# ============================================================================
# Scripts de utilidad - CORREGIDO
# ============================================================================

create-verify-script:
	@echo "ðŸ“ Creando script de verificaciÃ³n protobuf..."
	@vagrant ssh -c "cat > /vagrant/scripts/verify_protobuf.sh << 'EOF'"
	@vagrant ssh -c "echo '#!/bin/bash' >> /vagrant/scripts/verify_protobuf.sh"
	@vagrant ssh -c "echo 'echo \"ðŸ” Verificando consistencia protobuf...\"' >> /vagrant/scripts/verify_protobuf.sh"
	@vagrant ssh -c "echo 'echo \"========================================\"' >> /vagrant/scripts/verify_protobuf.sh"
	@vagrant ssh -c "echo 'echo \"\"' >> /vagrant/scripts/verify_protobuf.sh"
	@vagrant ssh -c "echo 'echo \"ðŸ“Š Checksums de archivos .pb.cc:\"' >> /vagrant/scripts/verify_protobuf.sh"
	@vagrant ssh -c "echo 'find /vagrant -name \"network_security.pb.cc\" -exec sha256sum {} \; | sort' >> /vagrant/scripts/verify_protobuf.sh"
	@vagrant ssh -c "echo 'echo \"\"' >> /vagrant/scripts/verify_protobuf.sh"
	@vagrant ssh -c "echo 'echo \"ðŸ“Š Checksums de archivos .pb.h:\"' >> /vagrant/scripts/verify_protobuf.sh"
	@vagrant ssh -c "echo 'find /vagrant -name \"network_security.pb.h\" -exec sha256sum {} \; | sort' >> /vagrant/scripts/verify_protobuf.sh"
	@vagrant ssh -c "echo 'echo \"\"' >> /vagrant/scripts/verify_protobuf.sh"
	@vagrant ssh -c "echo 'echo \"âœ… Todos los checksums deben ser IDÃ‰NTICOS\"' >> /vagrant/scripts/verify_protobuf.sh"
	@vagrant ssh -c "echo 'echo \"âŒ Si son diferentes: PROBLEMA DE INCONSISTENCIA\"' >> /vagrant/scripts/verify_protobuf.sh"
	@vagrant ssh -c "chmod +x /vagrant/scripts/verify_protobuf.sh"
	@echo "âœ… Script de verificaciÃ³n creado"

# ============================================================================
# Desarrollo rÃ¡pido
# ============================================================================

quick-fix: kill-lab proto-unified create-verify-script
	@echo "ðŸ”„ Aplicando fix rÃ¡pido..."
	@$(MAKE) rebuild-unified
	@echo "âœ… Fix aplicado - verificar con: make proto-verify"

dev-setup-unified: up lab-start build-unified create-verify-script
	@echo ""
	@echo "âœ… Development environment con protobuf unificado listo"
	@echo ""
	@echo "VerificaciÃ³n:"
	@echo "  make proto-verify          # Verificar consistencia protobuf"
	@echo "  make run-lab-dev           # Ejecutar lab"
	@echo "  make logs-lab              # Monitorear logs"

.DEFAULT_GOAL := help