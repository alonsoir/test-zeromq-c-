# Vagrantfile para validaciÃ³n Gateway Mode - DÃ­a 10
Vagrant.configure("2") do |config|
  # ConfiguraciÃ³n global
  config.vm.box = "debian/bookworm64"
  config.vm.box_version = "12.20240905.1"

  # =========================================================================
  # VM 1: ML DEFENDER (ConfiguraciÃ³n dual-NIC optimizada)
  # =========================================================================
  config.vm.define "defender", primary: true do |defender|
    defender.vm.hostname = "ml-defender-gateway"
    defender.vm.provider "virtualbox" do |vb|
      vb.name = "ml-defender-gateway"
      vb.memory = "4096"    # 4GB RAM (reducido de 8GB)
      vb.cpus = 4           # 4 cores (reducido de 6)
      vb.customize ["modifyvm", :id, "--ioapic", "on"]

      # OptimizaciÃ³n NICs: todas VirtIO
      (1..4).each do |nic|
        vb.customize ["modifyvm", :id, "--nictype#{nic}", "virtio"]
        vb.customize ["modifyvm", :id, "--nicpromisc#{nic}", "allow-all"]
      end
    end

    # ğŸ”¥ REDES CRÃTICAS para Gateway Mode:
    # eth0: NAT (Vagrant management) - OBLIGATORIO
    # eth1: 192.168.56.20 (WAN-facing, host-only) - Para conexiÃ³n desde host
    # eth2: (OPCIONAL) public_network para captura externa
    # eth3: 192.168.100.1 (LAN-facing, internal) - INTERFAZ GATEWAY MODE

    # eth1: WAN interface (host-only, desde macOS)
    defender.vm.network "private_network",
      ip: "192.168.56.20",
      virtualbox__intnet: false  # host-only network

    # eth3: LAN interface (internal network para gateway mode) - PRIORIDAD 1
    defender.vm.network "private_network",
      ip: "192.168.100.1",
      virtualbox__intnet: "ml_defender_gateway_lan"  # CRÃTICO: misma red que client

    # eth2: Public network (opcional, comentado para velocidad)
    # defender.vm.network "public_network",
    #   bridge: "en0: Wi-Fi",
    #   auto_config: false

    # Puertos forward (solo los esenciales)
    defender.vm.network "forwarded_port", guest: 22, host: 2222, id: "ssh"
    defender.vm.network "forwarded_port", guest: 5571, host: 5571  # ZMQ sniffer

    # Sync folder optimizado
    defender.vm.synced_folder ".", "/vagrant",
      type: "virtualbox",
      mount_options: ["dmode=775,fmode=775"]

    # ğŸ”¥ PROVISIONING OPTIMIZADO (solo para gateway validation)
    defender.vm.provision "shell", name: "gateway-setup", run: "always", inline: <<-DEFENDER_SHELL
      set -x
      echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
      echo "â•‘  ML DEFENDER - GATEWAY MODE SETUP (DÃA 10)                â•‘"
      echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

      # 1. InstalaciÃ³n RÃPIDA de dependencias crÃ­ticas
      echo "ğŸ“¦ Instalando dependencias crÃ­ticas..."
      apt-get update -qq
      apt-get install -y --no-install-recommends \
        build-essential \
        clang llvm bpftool linux-headers-amd64 \
        libbpf-dev libelf-dev zlib1g-dev \
        libzmq3-dev libjsoncpp-dev \
        protobuf-compiler libprotobuf-dev \
        tcpdump ethtool iptables iproute2 \
        hping3 nmap tcpreplay iperf3 \
        curl wget git sudo

      # 2. ConfiguraciÃ³n de red GATEWAY MODE
      echo "ğŸŒ Configurando Gateway Mode..."

      # Activar IP forwarding
      sysctl -w net.ipv4.ip_forward=1
      echo "net.ipv4.ip_forward=1" >> /etc/sysctl.conf

      # Configurar NAT bÃ¡sico (para que client pueda salir a internet)
      iptables -t nat -A POSTROUTING -o eth1 -j MASQUERADE
      iptables -A FORWARD -i eth3 -o eth1 -j ACCEPT
      iptables -A FORWARD -i eth1 -o eth3 -m state --state RELATED,ESTABLISHED -j ACCEPT

      # 3. Configurar interfaces
      echo "ğŸ”§ Configurando interfaces..."

      # eth1 (WAN) - host-based mode
      if ip link show eth1 >/dev/null 2>&1; then
        ip link set eth1 up
        ip link set eth1 promisc on
        ethtool -K eth1 gro off tso off gso off 2>/dev/null || true
        echo "âœ… eth1 (WAN): 192.168.56.20 - promisc on"
      fi

      # eth3 (LAN) - gateway mode (CRÃTICO)
      if ip link show eth3 >/dev/null 2>&1; then
        ip link set eth3 up
        ip link set eth3 promisc on
        ethtool -K eth3 gro off tso off gso off 2>/dev/null || true
        echo "âœ… eth3 (LAN): 192.168.100.1 - gateway mode ready"
      else
        echo "âŒ ERROR: eth3 no encontrada - Gateway mode imposible"
        exit 1
      fi

      # 4. CompilaciÃ³n RÃPIDA del sniffer
      echo "ğŸ”¨ Compilando sniffer (solo eBPF + userspace)..."
      cd /vagrant/sniffer

      # Limpiar solo si existe build
      [ -d build ] && rm -rf build
      mkdir -p build
      cd build

      # CompilaciÃ³n mÃ­nima
      cmake .. \
        -DENABLE_ML_DETECTOR=OFF \
        -DENABLE_RAG=OFF \
        -DENABLE_FIREWALL=OFF \
        -DCMAKE_BUILD_TYPE=Release

      make -j$(nproc) sniffer

      if [ -f "sniffer" ]; then
        echo "âœ… Sniffer compilado exitosamente"
      else
        echo "âŒ ERROR: Fallo en compilaciÃ³n del sniffer"
        exit 1
      fi

      # 5. ConfiguraciÃ³n automÃ¡tica del sniffer
      echo "âš™ï¸  Creando configuraciÃ³n automÃ¡tica..."
      cat > /vagrant/sniffer/build/config_gateway.json << 'EOF'
{
  "mode": "dual_nic",
  "interfaces": [
    {
      "name": "eth1",
      "ip": "192.168.56.20",
      "mode": "host_based",
      "wan_facing": true
    },
    {
      "name": "eth3",
      "ip": "192.168.100.1",
      "mode": "gateway",
      "wan_facing": false
    }
  ],
  "zmq_port": 5571,
  "ring_buffer_size": 32,
  "capture_threads": 2,
  "log_level": "INFO",
  "log_file": "/tmp/sniffer_gateway.log"
}
EOF

      # 6. Crear script de inicio automÃ¡tico
      cat > /vagrant/start_gateway_test.sh << 'EOF'
#!/bin/bash
echo "ğŸš€ Iniciando ML Defender en modo Gateway..."
cd /vagrant/sniffer/build

# Matar procesos previos
sudo pkill -9 sniffer 2>/dev/null || true
sleep 1

# Iniciar sniffer con configuraciÃ³n gateway
sudo ./sniffer -c config_gateway.json > /tmp/sniffer_output.log 2>&1 &
SNIFFER_PID=$!

# Esperar 2 segundos para inicializaciÃ³n
sleep 2

# Verificar que estÃ¡ corriendo
if ps -p $SNIFFER_PID > /dev/null; then
    echo "âœ… Sniffer iniciado (PID: $SNIFFER_PID)"
    echo "ğŸ“Š Monitor: tail -f /tmp/sniffer_output.log"
    echo $SNIFFER_PID > /tmp/sniffer.pid
else
    echo "âŒ Error iniciando sniffer"
    cat /tmp/sniffer_output.log
    exit 1
fi
EOF

      chmod +x /vagrant/start_gateway_test.sh

      # 7. Crear script de validaciÃ³n
      cat > /vagrant/validate_gateway.sh << 'EOF'
#!/bin/bash
echo "ğŸ” Validando Gateway Mode..."
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

# Verificar que el sniffer estÃ¡ corriendo
if [ ! -f /tmp/sniffer.pid ]; then
    echo "âŒ Sniffer no estÃ¡ corriendo"
    echo "   Ejecuta: /vagrant/start_gateway_test.sh"
    exit 1
fi

PID=$(cat /tmp/sniffer.pid)
if ! ps -p $PID > /dev/null; then
    echo "âŒ Sniffer no estÃ¡ activo (PID: $PID)"
    exit 1
fi

# Verificar logs para eventos gateway
echo "ğŸ“Š Analizando logs del sniffer..."
LOG_FILE="/tmp/sniffer_output.log"

if [ ! -f "$LOG_FILE" ]; then
    echo "âŒ No hay archivo de logs"
    exit 1
fi

# Buscar eventos con ifindex=5 (eth3 en gateway mode)
ETH3_EVENTS=$(grep -c "ifindex=5" "$LOG_FILE" 2>/dev/null || echo "0")
ETH1_EVENTS=$(grep -c "ifindex=3" "$LOG_FILE" 2>/dev/null || echo "0")

echo "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
echo "â”‚  EVENTOS CAPTURADOS (Ãºltimos 60 segundos)  â”‚"
echo "â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤"
echo "â”‚ eth1 (ifindex=3): $ETH1_EVENTS eventos     â”‚"
echo "â”‚ eth3 (ifindex=5): $ETH3_EVENTS eventos     â”‚"
echo "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"

if [ "$ETH3_EVENTS" -gt 0 ]; then
    echo "âœ… âœ… âœ… GATEWAY MODE VALIDADO âœ… âœ… âœ…"
    echo "   Se capturaron $ETH3_EVENTS eventos en eth3 (gateway mode)"
    exit 0
else
    echo "âŒ GATEWAY MODE NO DETECTADO"
    echo "   Esperando eventos en eth3 (ifindex=5)..."
    echo "   Verifica que el cliente estÃ© generando trÃ¡fico"
    exit 1
fi
EOF

      chmod +x /vagrant/validate_gateway.sh

      # 8. Dashboard en tiempo real
      cat > /vagrant/gateway_dashboard.sh << 'EOF'
#!/bin/bash
clear
echo "=== ML DEFENDER GATEWAY DASHBOARD ==="
echo "Presiona Ctrl+C para salir"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

while true; do
    # Obtener timestamp
    TIMESTAMP=$(date '+%H:%M:%S')

    # Obtener estadÃ­sticas de red
    ETH1_PACKETS=$(cat /sys/class/net/eth1/statistics/rx_packets 2>/dev/null || echo "0")
    ETH3_PACKETS=$(cat /sys/class/net/eth3/statistics/rx_packets 2>/dev/null || echo "0")

    # Obtener eventos del sniffer
    if [ -f /tmp/sniffer_output.log ]; then
        ETH3_EVENTS=$(tail -100 /tmp/sniffer_output.log | grep -c "ifindex=5")
        ETH1_EVENTS=$(tail -100 /tmp/sniffer_output.log | grep -c "ifindex=3")
    else
        ETH3_EVENTS="0"
        ETH1_EVENTS="0"
    fi

    # Obtener uso de CPU del sniffer
    if [ -f /tmp/sniffer.pid ]; then
        SNIFFER_PID=$(cat /tmp/sniffer.pid)
        CPU_USAGE=$(ps -p $SNIFFER_PID -o %cpu 2>/dev/null | tail -1 | tr -d ' ' || echo "0.0")
    else
        CPU_USAGE="0.0"
    fi

    # Mostrar dashboard
    clear
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘  ML DEFENDER - GATEWAY MODE DASHBOARD                   â•‘"
    echo "â•‘  Time: $TIMESTAMP                                      â•‘"
    echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
    echo "â•‘  INTERFACE    PACKETS    EVENTS     STATUS              â•‘"
    echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
    echo "â•‘  eth1 (WAN)   $ETH1_PACKETS       $ETH1_EVENTS       Host-Based        â•‘"
    echo "â•‘  eth3 (LAN)   $ETH3_PACKETS       $ETH3_EVENTS       Gateway Mode      â•‘"
    echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
    echo "â•‘  Sniffer CPU: ${CPU_USAGE}%                               â•‘"
    echo "â•‘                                                     â•‘"

    # Estado de validaciÃ³n
    if [ "$ETH3_EVENTS" -gt 0 ]; then
        echo "â•‘  âœ… GATEWAY MODE VALIDATED                         â•‘"
        echo "â•‘  Events captured on eth3: $ETH3_EVENTS              â•‘"
    else
        echo "â•‘  ğŸ”„ Waiting for gateway traffic...                 â•‘"
        echo "â•‘  Send traffic from client VM to trigger capture    â•‘"
    fi

    echo "â•‘                                                     â•‘"
    echo "â•‘  Commands:                                         â•‘"
    echo "â•‘    â€¢ /vagrant/validate_gateway.sh                  â•‘"
    echo "â•‘    â€¢ tail -f /tmp/sniffer_output.log               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

    sleep 2
done
EOF

      chmod +x /vagrant/gateway_dashboard.sh

      echo ""
      echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
      echo "â•‘  ML DEFENDER - GATEWAY MODE READY                       â•‘"
      echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
      echo "â•‘  COMANDOS DISPONIBLES:                                  â•‘"
      echo "â•‘                                                         â•‘"
      echo "â•‘  1. Iniciar sniffer:  /vagrant/start_gateway_test.sh    â•‘"
      echo "â•‘  2. Validar gateway:  /vagrant/validate_gateway.sh      â•‘"
      echo "â•‘  3. Dashboard:        /vagrant/gateway_dashboard.sh     â•‘"
      echo "â•‘                                                         â•‘"
      echo "â•‘  INTERFACES CONFIGURADAS:                               â•‘"
      echo "â•‘    â€¢ eth1: 192.168.56.20 (WAN, host-based)             â•‘"
      echo "â•‘    â€¢ eth3: 192.168.100.1 (LAN, gateway mode)           â•‘"
      echo "â•‘                                                         â•‘"
      echo "â•‘  CLIENT VM debe usar gateway: 192.168.100.1             â•‘"
      echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

    DEFENDER_SHELL

    # Provisioning final (post-setup)
    defender.vm.provision "shell", name: "post-setup", run: "once", inline: <<-POST_SHELL
      echo "ğŸ‰ Setup completado!"
      echo "Para comenzar:"
      echo "1. vagrant ssh defender"
      echo "2. /vagrant/start_gateway_test.sh"
      echo "3. En otra terminal: vagrant ssh client"
      echo "4. En client: /vagrant/generate_traffic.sh"
    POST_SHELL
  end

  # =========================================================================
  # VM 2: CLIENT (Generador de trÃ¡fico para validaciÃ³n)
  # =========================================================================
  config.vm.define "client" do |client|
    client.vm.hostname = "ml-client"
    client.vm.provider "virtualbox" do |vb|
      vb.name = "ml-defender-client"
      vb.memory = "1024"    # 1GB RAM
      vb.cpus = 2           # 2 cores
      vb.customize ["modifyvm", :id, "--nictype1", "virtio"]
      vb.customize ["modifyvm", :id, "--nictype2", "virtio"]
    end

    # ğŸ”¥ RED: Solo necesita estar en la misma LAN que eth3 del defender
    # eth0: NAT (Vagrant management)
    # eth1: 192.168.100.50 (LAN, misma red que eth3 del defender)
    client.vm.network "private_network",
      ip: "192.168.100.50",
      virtualbox__intnet: "ml_defender_gateway_lan"  # CRÃTICO: misma red

    # Provisioning del cliente (mÃ­nimo, solo herramientas de test)
    client.vm.provision "shell", name: "client-setup", run: "always", inline: <<-CLIENT_SHELL
      set -x
      echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
      echo "â•‘  ML CLIENT - Traffic Generator Setup (DÃA 10)             â•‘"
      echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

      # 1. InstalaciÃ³n rÃ¡pida de herramientas
      apt-get update -qq
      apt-get install -y --no-install-recommends \
        curl wget iperf3 hping3 nmap iproute2 \
        tcpdump netcat-openbsd dnsutils

      # 2. Configurar red (gateway = defender eth3)
      echo "ğŸŒ Configurando red con gateway a defender..."
      ip route add default via 192.168.100.1 dev eth1

      # Configurar DNS
      echo "nameserver 8.8.8.8" > /etc/resolv.conf
      echo "nameserver 1.1.1.1" >> /etc/resolv.conf

      # 3. Crear scripts de generaciÃ³n de trÃ¡fico
      cat > /vagrant/generate_traffic.sh << 'EOF'
#!/bin/bash
echo "ğŸš€ Generador de trÃ¡fico para validaciÃ³n Gateway Mode"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "Selecciona tipo de trÃ¡fico:"
echo "1) TrÃ¡fico HTTP/HTTPS (curl a internet)"
echo "2) TrÃ¡fico ICMP (ping a internet)"
echo "3) Escaneo de puertos (nmap al defender)"
echo "4) TrÃ¡fico iperf3 (performance testing)"
echo "5) TrÃ¡fico mixto (completo)"
echo "6) Validar conectividad"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
read -p "OpciÃ³n [1-6]: " OPTION

case $OPTION in
    1)
        echo "ğŸŒ Generando trÃ¡fico HTTP/HTTPS..."
        for i in {1..10}; do
            echo "Request $i:"
            curl -s -I --connect-timeout 3 http://google.com | grep HTTP || echo "Failed"
            curl -s -I --connect-timeout 3 https://cloudflare.com | grep HTTP || echo "Failed"
            sleep 0.5
        done
        ;;
    2)
        echo "ğŸ“¡ Generando trÃ¡fico ICMP..."
        ping -c 10 8.8.8.8
        ping -c 5 192.168.100.1
        ;;
    3)
        echo "ğŸ” Escaneo de puertos al defender..."
        nmap -sS -p 22,80,443,8080,5571 192.168.100.1
        ;;
    4)
        echo "ğŸ“Š Performance testing con iperf3..."
        # Primero verificar que iperf3 server estÃ¡ corriendo en defender
        echo "Nota: En defender ejecuta: iperf3 -s"
        read -p "Â¿EstÃ¡ corriendo iperf3 server en defender? (y/n): " CONFIRM
        if [ "$CONFIRM" = "y" ]; then
            iperf3 -c 192.168.100.1 -t 10
        else
            echo "Skipping iperf3 test"
        fi
        ;;
    5)
        echo "ğŸŒ€ Generando trÃ¡fico mixto completo..."
        echo "Fase 1: ICMP"
        ping -c 5 8.8.8.8 &
        ping -c 5 192.168.100.1 &

        echo "Fase 2: HTTP"
        for i in {1..5}; do
            curl -s http://example.com > /dev/null &
            curl -s https://httpbin.org/get > /dev/null &
            sleep 0.3
        done

        echo "Fase 3: DNS"
        for i in {1..5}; do
            dig @8.8.8.8 google.com +short > /dev/null &
            nslookup cloudflare.com 1.1.1.1 > /dev/null &
            sleep 0.2
        done

        wait
        echo "âœ… TrÃ¡fico mixto generado"
        ;;
    6)
        echo "ğŸ” Validando conectividad..."
        echo "1. Gateway local (defender):"
        ping -c 2 192.168.100.1 && echo "âœ… Defender alcanzable" || echo "âŒ Defender NO alcanzable"

        echo "2. Internet (vÃ­a gateway):"
        ping -c 2 8.8.8.8 && echo "âœ… Internet alcanzable" || echo "âŒ Internet NO alcanzable"

        echo "3. DNS resolution:"
        nslookup google.com 8.8.8.8 && echo "âœ… DNS funcionando" || echo "âŒ DNS fallando"

        echo "4. Ruta por defecto:"
        ip route show default
        ;;
    *)
        echo "âŒ OpciÃ³n invÃ¡lida"
        ;;
esac

echo ""
echo "âš ï¸  Recuerda: El trÃ¡fico debe pasar por eth3 del defender"
echo "   Verifica logs en defender: tail -f /tmp/sniffer_output.log"
echo "   Busca eventos con 'ifindex=5' (eth3 en gateway mode)"
EOF

      chmod +x /vagrant/generate_traffic.sh

      # 4. Script de validaciÃ³n automÃ¡tica
      cat > /vagrant/auto_validate.sh << 'EOF'
#!/bin/bash
echo "ğŸ¤– VALIDACIÃ“N AUTOMÃTICA GATEWAY MODE"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "Este script generarÃ¡ trÃ¡fico y validarÃ¡ automÃ¡ticamente"
echo "que el defender estÃ¡ capturando en modo gateway"
echo ""
read -p "Â¿Comenzar validaciÃ³n automÃ¡tica? (y/n): " START

if [ "$START" != "y" ]; then
    echo "ValidaciÃ³n cancelada"
    exit 0
fi

echo ""
echo "FASE 1: ValidaciÃ³n de conectividad bÃ¡sica"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
ping -c 3 192.168.100.1
if [ $? -eq 0 ]; then
    echo "âœ… Defender alcanzable"
else
    echo "âŒ ERROR: Defender no alcanzable"
    exit 1
fi

ping -c 3 8.8.8.8
if [ $? -eq 0 ]; then
    echo "âœ… Internet alcanzable (vÃ­a gateway)"
else
    echo "âš ï¸  Advertencia: Internet no alcanzable, continuando..."
fi

echo ""
echo "FASE 2: GeneraciÃ³n de trÃ¡fico de prueba"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "Generando trÃ¡fico HTTP/HTTPS..."
for i in {1..5}; do
    echo "Request $i..."
    curl -s -I --connect-timeout 2 http://example.com > /dev/null
    curl -s -I --connect-timeout 2 https://httpbin.org/get > /dev/null
    sleep 0.5
done

echo "Generando trÃ¡fico ICMP..."
ping -c 5 8.8.8.8 > /dev/null &

echo "Generando trÃ¡fico DNS..."
for i in {1..3}; do
    dig @8.8.8.8 google.com +short > /dev/null
    sleep 0.3
done

wait

echo ""
echo "FASE 3: Resultados de validaciÃ³n"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "âš ï¸  IMPORTANTE: Ahora ejecuta en el defender:"
echo "   /vagrant/validate_gateway.sh"
echo ""
echo "Si ves 'GATEWAY MODE VALIDATED', Â¡Ã©xito!"
echo "Si ves 'GATEWAY MODE NO DETECTADO', revisa:"
echo "1. Â¿El sniffer estÃ¡ corriendo en defender?"
echo "2. Â¿La configuraciÃ³n dual-NIC es correcta?"
echo "3. Â¿El trÃ¡fico realmente pasa por eth3?"
EOF

      chmod +x /vagrant/auto_validate.sh

      echo ""
      echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
      echo "â•‘  CLIENT - TRAFFIC GENERATOR READY                       â•‘"
      echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
      echo "â•‘  COMANDOS DISPONIBLES:                                  â•‘"
      echo "â•‘                                                         â•‘"
      echo "â•‘  1. Generar trÃ¡fico: /vagrant/generate_traffic.sh       â•‘"
      echo "â•‘  2. ValidaciÃ³n auto: /vagrant/auto_validate.sh          â•‘"
      echo "â•‘                                                         â•‘"
      echo "â•‘  CONFIGURACIÃ“N DE RED:                                  â•‘"
      echo "â•‘    â€¢ IP: 192.168.100.50                                 â•‘"
      echo "â•‘    â€¢ Gateway: 192.168.100.1 (defender eth3)             â•‘"
      echo "â•‘    â€¢ DNS: 8.8.8.8, 1.1.1.1                              â•‘"
      echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

    CLIENT_SHELL
  end
end