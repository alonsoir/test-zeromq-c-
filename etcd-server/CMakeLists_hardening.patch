# Patch para CMakeLists.txt - Hardening Options
# Aplicar a: ml-detector, firewall-acl-agent, rag-security
#
# A√±adir DESPU√âS de project() y ANTES de add_executable()

# ==============================================================================
# HARDENING OPTIONS - Preparados para Fase Post-Papers
# ==============================================================================
# Para activar: cmake -DENABLE_HARDENING=ON ..
# Para sanitizers: cmake -DENABLE_HARDENING=ON -DSANITIZER=address ..
# ==============================================================================

option(ENABLE_HARDENING "Enable hardening compiler flags" OFF)
set(SANITIZER "" CACHE STRING "Sanitizer to use (address, thread, undefined, memory)")

if(ENABLE_HARDENING)
    message(STATUS "üõ°Ô∏è Hardening ENABLED - Security flags active")

    # Basic Security Flags
    add_compile_options(
        -Wall
        -Wextra
        -Werror
        -Wformat=2
        -Wformat-security
        -fstack-protector-strong
        -D_FORTIFY_SOURCE=2
        -fPIE
    )

    # Advanced Warnings
    add_compile_options(
        -Wconversion
        -Wsign-conversion
        -Wnull-dereference
        -Wdouble-promotion
        -Wshadow
        -Wcast-qual
    )

    # Linker Flags
    add_link_options(
        -pie
        -Wl,-z,relro
        -Wl,-z,now
    )

    # Sanitizers (use ONE at a time)
    if(SANITIZER STREQUAL "address")
        message(STATUS "üîç AddressSanitizer ENABLED (memory errors)")
        add_compile_options(-fsanitize=address -fno-omit-frame-pointer)
        add_link_options(-fsanitize=address)
    elseif(SANITIZER STREQUAL "thread")
        message(STATUS "üîç ThreadSanitizer ENABLED (race conditions)")
        add_compile_options(-fsanitize=thread)
        add_link_options(-fsanitize=thread)
    elseif(SANITIZER STREQUAL "undefined")
        message(STATUS "üîç UndefinedBehaviorSanitizer ENABLED")
        add_compile_options(-fsanitize=undefined)
        add_link_options(-fsanitize=undefined)
    elseif(SANITIZER STREQUAL "memory")
        message(STATUS "üîç MemorySanitizer ENABLED (uninitialized reads)")
        add_compile_options(-fsanitize=memory -fno-omit-frame-pointer)
        add_link_options(-fsanitize=memory)
    elseif(NOT SANITIZER STREQUAL "")
        message(WARNING "‚ö†Ô∏è Unknown sanitizer: ${SANITIZER}")
    endif()
else()
    message(STATUS "üîì Hardening DISABLED (development mode)")
endif()

# ==============================================================================
# USAGE EXAMPLES:
# ==============================================================================
# Fase actual (desarrollo):
#   cmake .. && make
#
# Fase hardening (basic security):
#   cmake -DENABLE_HARDENING=ON .. && make
#
# Fase hardening (con AddressSanitizer):
#   cmake -DENABLE_HARDENING=ON -DSANITIZER=address .. && make
#   ./ml-detector -c config.json
#
# Limpiar y cambiar sanitizer:
#   rm -rf * && cmake -DENABLE_HARDENING=ON -DSANITIZER=thread .. && make
#
# Performance Impact:
#   - Basic flags: ~5% overhead
#   - ASan: ~2√ó slowdown, ~3√ó memory
#   - TSan: ~5-15√ó slowdown, ~10√ó memory
#   - UBSan: ~20% overhead
#   - MSan: ~3√ó slowdown
# ==============================================================================