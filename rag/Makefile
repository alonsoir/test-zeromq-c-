.PHONY: all clean build configure test test-faiss test-onnx help

BUILD_DIR := build
CONFIG_DIR := config

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# MAIN TARGETS
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

all: build

configure:
	@echo "âš™ï¸  Configuring RAG Security System..."
	@mkdir -p $(BUILD_DIR)
	@cd $(BUILD_DIR) && cmake .. -DCMAKE_BUILD_TYPE=Release

build: configure
	@echo "ğŸ”¨ Building RAG..."
	@cd $(BUILD_DIR) && $(MAKE) -j$$(nproc)
	@echo "âœ… RAG compiled successfully!"
	@ls -lh $(BUILD_DIR)/rag-security

clean:
	@echo "ğŸ§¹ Cleaning RAG build..."
	@rm -rf $(BUILD_DIR)/*

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# TESTING TARGETS (Phase 2A)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

test: test-main
	@echo "âœ… All tests completed"

test-main:
	@echo "ğŸ§ª Testing RAG main executable..."
	@cd $(BUILD_DIR) && ./rag-security --test-config 2>&1 || echo "Test ejecutado"

# Test FAISS Integration
test-faiss: build-test-faiss
	@echo ""
	@echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
	@echo "ğŸ§ª Running FAISS Integration Test"
	@echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
	@if [ -f $(BUILD_DIR)/test_faiss_basic ]; then \
		cd $(BUILD_DIR) && ./test_faiss_basic; \
	else \
		echo "âŒ test_faiss_basic not found - FAISS not available?"; \
		echo "   Run 'make configure' to check FAISS status"; \
		exit 1; \
	fi
	@echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

build-test-faiss: configure
	@echo "ğŸ”¨ Building test_faiss_basic..."
	@cd $(BUILD_DIR) && $(MAKE) test_faiss_basic 2>&1 | grep -v "^make"

# Test ONNX Runtime
# Test ONNX Runtime
test-onnx: build-test-onnx
	@echo ""
	@echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
	@echo "ğŸ§ª Running ONNX Runtime Test"
	@echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
	@if [ -f $(BUILD_DIR)/test_onnx_basic ]; then \
		echo "ğŸ“ Generating dummy ONNX model..."; \
		cd tests && python3 create_dummy_model_lite.py > /dev/null 2>&1 && echo "âœ… Model generated" && ../build/test_onnx_basic; \
	else \
		echo "â„¹ï¸  test_onnx_basic not yet implemented"; \
	fi
	@echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

build-test-onnx: configure
	@echo "ğŸ”¨ Building test_onnx_basic..."
	@cd $(BUILD_DIR) && $(MAKE) test_onnx_basic 2>&1 | grep -v "^make" || echo "Not yet created"

# Run all Phase 2A tests
test-all: test-faiss test-onnx
	@echo ""
	@echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
	@echo "â•‘  All Phase 2A Tests Completed                             â•‘"
	@echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# VERIFICATION TARGETS
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

verify-libs:
	@echo "ğŸ” Verifying Phase 2A libraries..."
	@echo ""
	@echo "FAISS:"
	@ls -lh /usr/local/lib/libfaiss.so 2>/dev/null || echo "  âŒ libfaiss.so not found"
	@ls -d /usr/local/include/faiss 2>/dev/null || echo "  âŒ FAISS headers not found"
	@echo ""
	@echo "ONNX Runtime:"
	@ls -lh /usr/local/lib/libonnxruntime.so 2>/dev/null || echo "  âŒ libonnxruntime.so not found"
	@find /usr/local/include -name "onnxruntime*.h" 2>/dev/null | head -3 || echo "  âŒ ONNX headers not found"
	@echo ""

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# RUN TARGETS
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

run:
	@echo "ğŸš€ Running RAG..."
	@cd $(BUILD_DIR) && ./rag-security -c ../$(CONFIG_DIR)/rag-config.json

run-debug:
	@echo "ğŸ› Running RAG in debug mode..."
	@cd $(BUILD_DIR) && ./rag-security -c ../$(CONFIG_DIR)/rag-config.json --debug

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# HELP
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

help:
	@echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
	@echo "â•‘  RAG Security System - Makefile Help                      â•‘"
	@echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
	@echo ""
	@echo "ğŸ“¦ Main Targets:"
	@echo "  make              - Build RAG Security"
	@echo "  make clean        - Clean build directory"
	@echo "  make configure    - Configure CMake"
	@echo "  make run          - Run RAG with config"
	@echo "  make run-debug    - Run with debug output"
	@echo ""
	@echo "ğŸ§ª Testing (Phase 2A):"
	@echo "  make test         - Run main tests"
	@echo "  make test-faiss   - Run FAISS integration test"
	@echo "  make test-onnx    - Run ONNX Runtime test (Day 32)"
	@echo "  make test-all     - Run all Phase 2A tests"
	@echo ""
	@echo "ğŸ” Verification:"
	@echo "  make verify-libs  - Verify FAISS + ONNX installation"
	@echo ""
	@echo "ğŸ“ Quick Start:"
	@echo "  1. make configure    # Configure build"
	@echo "  2. make              # Build everything"
	@echo "  3. make test-faiss   # Test FAISS integration"
	@echo "  4. make verify-libs  # Verify libraries"
	@echo ""