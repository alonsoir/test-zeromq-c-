#!/bin/bash

# Monitoreo en tiempo real del test de estabilidad

watch -n 15 '
clear
echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘  Monitor de Estabilidad - ActualizaciÃ³n cada 15s          â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""
date
echo ""

# Uptime de procesos
echo "ğŸƒ PROCESOS ACTIVOS:"
SNIFFER_PID=$(pgrep -f "sniffer -c")
DETECTOR_PID=$(pgrep -f "ml-detector -c")

if [ -n "$SNIFFER_PID" ]; then
    SNIFFER_TIME=$(ps -p $SNIFFER_PID -o etime= | xargs)
    SNIFFER_CPU=$(ps -p $SNIFFER_PID -o %cpu= | xargs)
    SNIFFER_MEM=$(ps -p $SNIFFER_PID -o %mem= | xargs)
    echo "  âœ… Sniffer (PID $SNIFFER_PID)"
    echo "     Uptime: $SNIFFER_TIME | CPU: ${SNIFFER_CPU}% | MEM: ${SNIFFER_MEM}%"
else
    echo "  âŒ Sniffer: NO RUNNING"
fi

if [ -n "$DETECTOR_PID" ]; then
    DETECTOR_TIME=$(ps -p $DETECTOR_PID -o etime= | xargs)
    DETECTOR_CPU=$(ps -p $DETECTOR_PID -o %cpu= | xargs)
    DETECTOR_MEM=$(ps -p $DETECTOR_PID -o %mem= | xargs)
    echo "  âœ… ml-detector (PID $DETECTOR_PID)"
    echo "     Uptime: $DETECTOR_TIME | CPU: ${DETECTOR_CPU}% | MEM: ${DETECTOR_MEM}%"
else
    echo "  âŒ ml-detector: NO RUNNING"
fi

echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""

# Stats del sniffer
echo "ğŸ“¦ SNIFFER:"
tail -5 /tmp/sniffer.log 2>/dev/null | grep "ESTADÃSTICAS" -A 2 | tail -3

# Ãšltimos errores ZMQ
ZMQ_ERRORS=$(grep -c "ZMQ send fallÃ³" /tmp/sniffer.log 2>/dev/null || echo 0)
if [ $ZMQ_ERRORS -eq 0 ]; then
    echo "  âœ… Sin errores ZMQ"
else
    echo "  âš ï¸  Errores ZMQ: $ZMQ_ERRORS (verificar si fueron antes de arrancar ml-detector)"
fi

echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""

# Stats del ml-detector
echo "ğŸ¤– ML-DETECTOR:"
TOTAL_ATTACKS=$(grep -c "Attack detected" /tmp/ml-detector.log 2>/dev/null || echo 0)
echo "  Total attacks: $TOTAL_ATTACKS"

# Ãšltimas detecciones
echo "  Ãšltimas 3 detecciones:"
grep "Attack detected" /tmp/ml-detector.log 2>/dev/null | tail -3 | while read line; do
    echo "    - $(echo $line | cut -d\] -f3-)"
done

echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""

# Memoria total del sistema
echo "ğŸ’¾ SISTEMA:"
free -h | grep Mem | awk "{print \"  RAM: \" \$3 \" usado de \" \$2 \" (\" int(\$3/\$2*100) \"%)\"}"

echo ""
echo "ğŸ›ï¸  Construyendo fundaciones para mil aÃ±os de runtime..."
'
