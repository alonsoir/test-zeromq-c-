#!/bin/bash

# Script para instalar dependencias espec√≠ficas del sniffer eBPF avanzado
# Separado del provisioning base de Vagrant para mantener modularidad
#
# Uso: ./scripts/install-sniffer-deps.sh
#      sudo ./scripts/install-sniffer-deps.sh --force-update

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(dirname "$SCRIPT_DIR")"

echo "üîß Instalador de dependencias del sniffer eBPF avanzado"
echo "üìÅ Proyecto: $PROJECT_ROOT"
echo ""

# Verificar si estamos en un entorno Vagrant
if [ -f "/etc/environment" ] && grep -q "VAGRANT_HOST_IP" /etc/environment 2>/dev/null; then
    echo "üè† Entorno Vagrant detectado"
    IN_VAGRANT=true
else
    echo "üíª Entorno local detectado"
    IN_VAGRANT=false
fi

echo "üîç Detectando sistema operativo..."

# Detectar distribuci√≥n
if [ -f /etc/os-release ]; then
    . /etc/os-release
    OS=$NAME
    VERSION=$VERSION_ID
else
    echo "‚ùå No se puede detectar el sistema operativo"
    exit 1
fi

echo "üìã Sistema detectado: $OS $VERSION"

install_debian_ubuntu() {
    echo "üì¶ Instalando dependencias del sniffer en Debian/Ubuntu..."

    # Actualizar repositorios solo si es necesario
    if [ "$1" = "--force-update" ] || [ ! -f /var/cache/apt/pkgcache.bin ]; then
        echo "üîÑ Actualizando repositorios..."
        apt-get update
    fi

    echo "üîß Instalando herramientas de compilaci√≥n core..."
    apt-get install -y \
        build-essential \
        cmake \
        pkg-config \
        clang \
        llvm \
        bpftool

    echo "üì° Instalando dependencias de networking y eBPF..."
    apt-get install -y \
        libbpf-dev \
        libzmq3-dev \
        libjsoncpp-dev

    echo "üìã Instalando dependencias de serializaci√≥n..."
    apt-get install -y \
        libprotobuf-dev \
        protobuf-compiler

    echo "üóúÔ∏è Instalando librer√≠as de compresi√≥n (OBLIGATORIAS para sniffer)..."
    apt-get install -y \
        liblz4-dev \
        libzstd-dev \
        libsnappy-dev

    echo "üîê Instalando dependencias para cifrado futuro..."
    apt-get install -y \
        libcurl4-openssl-dev \
        libssl-dev

    echo "‚ö° Instalando optimizaciones de rendimiento..."
    apt-get install -y \
        libnuma-dev

    echo "üß™ Verificando instalaci√≥n..."
    verify_dependencies

    echo "‚úÖ Dependencias del sniffer instaladas correctamente"
}

verify_dependencies() {
    echo "üîç Verificando dependencias cr√≠ticas..."

    # Verificar pkg-config para las librer√≠as principales
    local missing=()

    for lib in libbpf libzmq jsoncpp liblz4 libzstd protobuf; do
        if ! pkg-config --exists "$lib" 2>/dev/null; then
            case "$lib" in
                "libzmq")
                    if ! pkg-config --exists "libzmq3" 2>/dev/null; then
                        missing+=("$lib")
                    fi
                    ;;
                "liblz4")
                    missing+=("$lib - CR√çTICO: Compresi√≥n LZ4 requerida")
                    ;;
                "libzstd")
                    missing+=("$lib - CR√çTICO: Compresi√≥n Zstd requerida")
                    ;;
                *)
                    missing+=("$lib")
                    ;;
            esac
        fi
    done

    # Verificar herramientas de compilaci√≥n
    for tool in clang bpftool protoc; do
        if ! command -v "$tool" >/dev/null 2>&1; then
            missing+=("$tool (comando)")
        fi
    done

    if [ ${#missing[@]} -gt 0 ]; then
        echo "‚ùå Dependencias faltantes:"
        printf '   - %s\n' "${missing[@]}"
        echo ""
        echo "üí° Sugerencia: Ejecuta con --force-update para forzar reinstalaci√≥n"
        return 1
    fi

    echo "‚úÖ Todas las dependencias cr√≠ticas est√°n instaladas"

    # Mostrar versiones para debugging
    echo ""
    echo "üìã Versiones instaladas:"
    echo "   libbpf: $(pkg-config --modversion libbpf 2>/dev/null || echo 'N/A')"
    echo "   libzmq: $(pkg-config --modversion libzmq 2>/dev/null || pkg-config --modversion libzmq3 2>/dev/null || echo 'N/A')"
    echo "   jsoncpp: $(pkg-config --modversion jsoncpp 2>/dev/null || echo 'N/A')"
    echo "   liblz4: $(pkg-config --modversion liblz4 2>/dev/null || echo 'N/A')"
    echo "   libzstd: $(pkg-config --modversion libzstd 2>/dev/null || echo 'N/A')"
    echo "   protobuf: $(pkg-config --modversion protobuf 2>/dev/null || echo 'N/A')"
    echo "   clang: $(clang --version | head -1)"
    echo ""
}

install_centos_rhel() {
    echo "üì¶ Instalando dependencias en CentOS/RHEL..."

    # Habilitar EPEL para dependencias adicionales
    dnf install -y epel-release
    dnf update -y

    # Dependencias core
    dnf install -y \
        gcc-c++ \
        cmake \
        pkgconfig \
        clang \
        llvm \
        libbpf-devel \
        zeromq-devel \
        jsoncpp-devel \
        protobuf-devel \
        protobuf-compiler \
        bpftool

    # Dependencias de compresi√≥n
    echo "üóúÔ∏è Instalando librer√≠as de compresi√≥n..."
    dnf install -y \
        lz4-devel \
        libzstd-devel \
        snappy-devel

    # Dependencias opcionales
    echo "üîß Instalando dependencias opcionales..."
    dnf install -y \
        libcurl-devel \
        numactl-devel

    echo "‚úÖ Dependencias instaladas correctamente"
}

install_arch() {
    echo "üì¶ Instalando dependencias en Arch Linux..."

    pacman -Sy

    # Dependencias core
    pacman -S --noconfirm \
        base-devel \
        cmake \
        pkgconf \
        clang \
        llvm \
        libbpf \
        zeromq \
        jsoncpp \
        protobuf \
        bpf

    # Dependencias de compresi√≥n
    echo "üóúÔ∏è Instalando librer√≠as de compresi√≥n..."
    pacman -S --noconfirm \
        lz4 \
        zstd \
        snappy

    # Dependencias opcionales
    echo "üîß Instalando dependencias opcionales..."
    pacman -S --noconfirm \
        curl \
        numactl

    echo "‚úÖ Dependencias instaladas correctamente"
}

# Verificar permisos de root
if [ "$EUID" -ne 0 ]; then
    echo "‚ùå Este script necesita ejecutarse como root (sudo)"
    echo "   Uso: sudo $0 [--force-update]"
    exit 1
fi

# Verificar si ya tenemos las dependencias b√°sicas antes de proceder
check_basic_system() {
    echo "üè• Verificando estado del sistema base..."

    # Verificar que estamos en un sistema con apt
    if ! command -v apt-get >/dev/null 2>&1; then
        echo "‚ùå Este script est√° optimizado para sistemas Debian/Ubuntu"
        echo "   Para otros sistemas, instala manualmente las dependencias"
        exit 1
    fi

    # Verificar conectividad de red
    if ! ping -c 1 deb.debian.org >/dev/null 2>&1 && ! ping -c 1 archive.ubuntu.com >/dev/null 2>&1; then
        echo "‚ö†Ô∏è  Sin conectividad a repositorios, intentando instalar con cache local"
    fi

    echo "‚úÖ Sistema base verificado"
}

# Preparar configuraci√≥n post-instalaci√≥n
setup_sniffer_config() {
    echo "‚öôÔ∏è Configurando entorno post-instalaci√≥n para sniffer..."

    # Crear directorios si no existen
    mkdir -p "$PROJECT_ROOT/sniffer/build"
    mkdir -p "$PROJECT_ROOT/sniffer/config"
    mkdir -p "$PROJECT_ROOT/sniffer/logs"

    # Crear archivo de estado de dependencias
    cat > "$PROJECT_ROOT/sniffer/.deps-installed" << EOF
# Dependencias del sniffer instaladas
# Generado autom√°ticamente por install-sniffer-deps.sh
INSTALL_DATE=$(date -Iseconds)
SYSTEM=$(lsb_release -ds 2>/dev/null || echo "Unknown")
COMPRESSION_MANDATORY=true
ENCRYPTION_SUPPORT=true
ETCD_INTEGRATION=true
EOF

    # Si estamos en Vagrant, registrar en el log del sistema
    if [ "$IN_VAGRANT" = true ]; then
        echo "$(date -Iseconds) - Sniffer dependencies installed" >> /var/log/vagrant-components.log
    fi

    echo "‚úÖ Configuraci√≥n post-instalaci√≥n completada"
}

# Mostrar resumen final con informaci√≥n espec√≠fica del sniffer
show_summary() {
    echo ""
    echo "üéâ ¬°Instalaci√≥n de dependencias del sniffer completada!"
    echo ""
    echo "üìä Caracter√≠sticas habilitadas:"
    echo "   ‚úÖ Compresi√≥n LZ4 (obligatoria)"
    echo "   ‚úÖ Compresi√≥n Zstd (obligatoria)"
    echo "   ‚úÖ Compresi√≥n Snappy (opcional)"
    echo "   ‚úÖ Soporte para cifrado via etcd (futuro)"
    echo "   ‚úÖ Optimizaciones NUMA"
    echo "   ‚úÖ eBPF/XDP avanzado"
    echo ""
    echo "üöÄ Pr√≥ximos pasos:"
    echo "   1. cd $PROJECT_ROOT"
    echo "   2. make sniffer-build"
    echo "   3. make sniffer-start"
    echo ""
    if [ "$IN_VAGRANT" = true ]; then
        echo "üí° Vagrant detectado:"
        echo "   - Endpoint configurado autom√°ticamente via etcd"
        echo "   - IP del host: \$(grep VAGRANT_HOST_IP /etc/environment | cut -d= -f2)"
        echo ""
    fi
    echo "üìù Log de instalaci√≥n guardado en:"
    echo "   $PROJECT_ROOT/sniffer/.deps-installed"
    echo ""
}

# Funci√≥n principal
main() {
    local force_update=false

    # Procesar argumentos
    for arg in "$@"; do
        case $arg in
            --force-update)
                force_update=true
                shift
                ;;
            --help|-h)
                echo "Uso: sudo $0 [--force-update]"
                echo ""
                echo "Opciones:"
                echo "  --force-update    Forzar actualizaci√≥n de repositorios"
                echo "  --help           Mostrar esta ayuda"
                exit 0
                ;;
        esac
    done

    check_basic_system

    # Instalar seg√∫n la distribuci√≥n
    case $OS in
        "Debian GNU/Linux"|"Ubuntu")
            if [ "$force_update" = true ]; then
                install_debian_ubuntu --force-update
            else
                install_debian_ubuntu
            fi
            ;;
        "CentOS Linux"|"Red Hat Enterprise Linux"|"Fedora Linux")
            install_centos_rhel
            ;;
        "Arch Linux")
            install_arch
            ;;
        *)
            echo "‚ùå Distribuci√≥n no soportada: $OS"
            echo ""
            echo "üìã Para instalaci√≥n manual, necesitas estas dependencias:"
            echo "üîß Compilaci√≥n:"
            echo "   - build-essential, cmake, pkg-config"
            echo "   - clang, llvm, bpftool"
            echo "üì° Networking/eBPF:"
            echo "   - libbpf-dev, libzmq3-dev, libjsoncpp-dev"
            echo "üìã Serializaci√≥n:"
            echo "   - libprotobuf-dev, protobuf-compiler"
            echo "üóúÔ∏è Compresi√≥n (OBLIGATORIA):"
            echo "   - liblz4-dev, libzstd-dev, libsnappy-dev"
            echo "üîê Cifrado/Red:"
            echo "   - libcurl4-openssl-dev, libssl-dev"
            echo "‚ö° Optimizaci√≥n:"
            echo "   - libnuma-dev"
            echo ""
            exit 1
            ;;
    esac

    setup_sniffer_config
    show_summary
}

# Ejecutar funci√≥n principal con todos los argumentos
main "$@"